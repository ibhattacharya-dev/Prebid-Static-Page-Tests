<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Mediafuse Prebid Adapter Test (PB9 / PB10)</title>

  <!-- Optional GPT (banner rendering only) -->
  <script async src="https://securepubads.g.doubleclick.net/tag/js/gpt.js"></script>

  <!-- Local Prebid build -->
  <script src="./prebid.js"></script>

  <script>
    var googletag = googletag || {};
    googletag.cmd = googletag.cmd || [];
  </script>

  <style>
    .slot {
      border: 1px dashed #999;
      margin: 16px 0;
      padding: 8px;
    }
  </style>
</head>

<body>
  <h2>Mediafuse Adapter Test</h2>

  <div id="banner1" class="slot" style="width:300px;height:250px">
    Primary Banner (37151836)
  </div>

  <div id="banner2" class="slot" style="width:300px;height:250px">
    Live Banner (37151837)
  </div>

  <div id="native" class="slot">
    Native (37151838 – console only)
  </div>

  <div id="outstream" class="slot" style="width:300px;height:250px">
    Outstream Video (37151840)
  </div>

  <div id="instream" class="slot">
    Instream / AdPod (37151839 / 37151841 – console only)
  </div>

  <script>
    var adUnits = [
      // Primary banner
      {
        code: 'banner1',
        mediaTypes: {
          banner: { sizes: [[300, 250]] }
        },
        bids: [{
          bidder: 'mediafuse',
          params: { placement_id: 37151836 }
        }]
      },

      // Live banner example
      {
        code: 'banner2',
        mediaTypes: {
          banner: { sizes: [[300, 250]] }
        },
        bids: [{
          bidder: 'mediafuse',
          params: { placement_id: 37151837 }
        }]
      },

      // Native
      {
        code: 'native',
        mediaTypes: {
          native: {
            title: { required: true },
            image: { required: true },
            body: { required: true },
            clickUrl: { required: true }
          }
        },
        bids: [{
          bidder: 'mediafuse',
          params: { placement_id: 37151838 }
        }]
      },

      // Outstream video
      {
        code: 'outstream',
        mediaTypes: {
          video: {
            context: 'outstream',
            playerSize: [300, 250]
          }
        },
        bids: [{
          bidder: 'mediafuse',
          params: { placement_id: 37151840 }
        }]
      },

      // Instream / AdPod
      {
        code: 'instream',
        mediaTypes: {
          video: {
            context: 'instream',
            playerSize: [640, 360],
            adPodDurationSec: 90,          // 3 ads * 30s
            durationRangeSec: [15, 30],
            requireExactDuration: false
          }
        },
        bids: [{
          bidder: 'mediafuse',
          params: { placement_id: 37151841 }
        }]
      }
    ];

    pbjs.que.push(function () {
      // Works in PB9 and PB10
      pbjs.setConfig({
        debug: true,
        bidderSettings: {
          mediafuse: {
            enabled: true,
            storageAllowed: true
          }
        }
      });

      // PB10-only activity controls (safe in PB9)
      if (pbjs.setConfig) {
        pbjs.setConfig({
          bidderSettings: {
            mediafuse: {
              allowActivities: {
                fetch: true,
                iframe: true,
                image: true,
                transmitTid: true,
                accessDevice: true
              }
            }
          }
        });
      }

      pbjs.addAdUnits(adUnits);

      // Debug hooks (critical for low-fill testing)
      pbjs.onEvent('bidRequested', d => {
        console.log('Bid requested:', d);
      });

      pbjs.onEvent('bidResponse', b => {
        console.log('Bid response:', b);
      });

      pbjs.requestBids({
        timeout: 3000,
        bidsBackHandler: function () {
          // PB9 + PB10 safe way to inspect bids
          var responses = pbjs.getBidResponses();
          var allBids = Object.values(responses).flatMap(r => r.bids);
          console.log('All bids:', allBids);

          // Banner render (if any bids exist)
          if (pbjs.setTargetingForGPTAsync) {
            pbjs.setTargetingForGPTAsync();
            googletag.cmd.push(function () {
              googletag.display('banner1');
              googletag.display('banner2');
            });
          }
        }
      });
    });
  </script>
</body>
</html>
